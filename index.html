<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KANBAN - Plan de production</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
<style>
  :root{--bg:#1e1e2f;--card:#2c2c40;--muted:#aaa}
  body{margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; padding:20px;}
  h1{margin:0 0 18px;text-transform:uppercase}
  .controls{display:flex;gap:8px;align-items:center;margin-bottom:14px}
  button{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#ddd}
  button.primary{background:#2563eb;color:#fff}
  .board{display:flex;flex-direction:column;gap:20px}
  .theme{border-radius:10px;padding:8px;background:transparent}
  .theme-title{font-size:16px;font-weight:700;margin-bottom:8px;text-transform:uppercase;cursor:pointer}
  .theme-columns{display:flex;gap:16px}
  .column{flex:1;min-height:180px;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:10px;box-sizing:border-box;overflow:hidden}
  .col-head{display:flex;align-items:center;justify-content:center;font-weight:700;text-transform:uppercase;padding:6px 10px;border-radius:6px;margin-bottom:6px}
  .column-a-faire .col-head{background:#b33d3d;color:white}    /* rouge */
  .column-en-cours .col-head{background:#c19a3c;color:white}   /* jaune */
  .column-termine .col-head{background:#2b8a5e;color:white}     /* vert */
  .tasks-list{flex:1;overflow:auto;padding:6px;border-radius:8px}
  .task{background:var(--card);padding:10px;border-radius:8px;margin-bottom:8px;position:relative;box-shadow:0 6px 14px rgba(0,0,0,0.35)}
  .task-header{font-weight:700;margin-bottom:6px;text-transform:uppercase}
  .task-meta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
  .task .delete-task{position:absolute;right:8px;top:8px;color:#ef4444;cursor:pointer}
  .add-area{display:flex;gap:8px;align-items:center}
  .add-sub{color:#60a5fa;cursor:pointer;font-weight:600}
  .small{font-size:13px}
  /* modal */
  #modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:40}
  .modal-card{background:var(--card);padding:18px;border-radius:10px;min-width:320px;max-width:520px}
  .field{margin-bottom:8px}
  label{display:block;font-size:13px;color:#ddd;margin-bottom:6px}
  input[type=text], input[type=date], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#1b1b26;color:#fff}
  .footer-controls{display:flex;gap:10px;justify-content:flex-end;margin-top:6px}
  .tools{margin-left:auto;display:flex;gap:8px}
  .note{font-size:13px;color:#bbb;margin-top:10px}
  input[type=file]{display:none}
</style>
</head>
<body>

<h1>PLAN DE PRODUCTION — IMAGES</h1>

<div class="controls">
  <button id="btnAddTheme" class="primary">+ TYPE DE PROJET</button>
  <div class="tools">
    <button id="btnExport" class="ghost">Exporter JSON</button>
    <label class="ghost" for="importFile" style="cursor:pointer;padding:6px 10px;border-radius:8px;">Importer</label>
    <input id="importFile" type="file" accept=".json">
    <button id="btnReset" class="ghost">Réinitialiser</button>
  </div>
</div>

<div id="board" class="board"></div>

<div id="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <h3 id="modalTitle">ÉDITER PROJET</h3>
    <div class="field"><label>TITRE</label><input id="mTitle" type="text" /></div>
    <div class="field"><label>DATE DÉBUT</label><input id="mStart" type="date" /></div>
    <div class="field"><label>DATE FIN</label><input id="mEnd" type="date" /></div>
    <div class="field"><label>PERSONNE(S)</label><input id="mTeam" type="text" /></div>
    <div class="field"><label>PRIORITÉ</label>
      <select id="mPriority"><option>Haute</option><option>Moyenne</option><option>Basse</option></select>
    </div>
    <div class="footer-controls">
      <button id="modalCancel" class="ghost">ANNULER</button>
      <button id="modalSave" class="primary">ENREGISTRER</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
/* ===== Robust Kanban — single file =====
   - Unique IDs for themes/tasks
   - tasks-list container is sortable (prevents index desync)
   - drag/drop updates data model by task id and saves to localStorage
   - export/import JSON and reset
*/

(() => {
  const STORAGE_KEY = 'kanban_production_v2';
  const STATUS = ["À faire","En cours","Terminé"];
  let board = [];
  let currentEdit = null; // {themeId, status, taskId}
  let sortables = [];     // for destroying before re-init

  // elements
  const boardEl = document.getElementById('board');
  const btnAddTheme = document.getElementById('btnAddTheme');
  const btnExport = document.getElementById('btnExport');
  const importFile = document.getElementById('importFile');
  const btnReset = document.getElementById('btnReset');
  const modal = document.getElementById('modal');
  const mTitle = document.getElementById('mTitle');
  const mStart = document.getElementById('mStart');
  const mEnd = document.getElementById('mEnd');
  const mTeam = document.getElementById('mTeam');
  const mPriority = document.getElementById('mPriority');
  const modalSave = document.getElementById('modalSave');
  const modalCancel = document.getElementById('modalCancel');

  // helper: create stable unique id
  function uid(prefix='id') {
    return prefix + '-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
  }

  // load or init sample
  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        board = JSON.parse(raw);
      } else {
        // sample initial data
        board = [{
          id: uid('theme'),
          title: 'EXEMPLE TYPE',
          "À faire": [{ id: uid('task'), title:'MAQUETTE', start:'', end:'', team:'Alice', priority:'Moyenne', checklist:[] }],
          "En cours": [],
          "Terminé": []
        }];
        save(); // persist sample once
      }
    } catch (err) {
      console.error('Load error', err);
      board = [];
    }
  }

  // save to localStorage safely
  function save() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(board));
    } catch (err) {
      console.error('Save failed', err);
      alert('Erreur lors de la sauvegarde (localStorage).');
    }
    render();
  }

  // clear existing Sortables instances
  function destroySortables() {
    sortables.forEach(s => {
      try { s.destroy(); } catch(e) {}
    });
    sortables = [];
  }

  // find theme by id
  function findThemeIndex(themeId) {
    return board.findIndex(t => t.id === themeId);
  }

  // render full UI
  function render() {
    destroySortables();
    boardEl.innerHTML = '';

    board.forEach(theme => {
      const themeEl = document.createElement('div');
      themeEl.className = 'theme';
      // theme title
      const titleEl = document.createElement('div');
      titleEl.className = 'theme-title';
      titleEl.textContent = theme.title.toUpperCase();
      titleEl.addEventListener('click', () => {
        const newTitle = prompt('NOUVEAU NOM DU TYPE DE PROJET:', theme.title);
        if (newTitle != null) {
          theme.title = String(newTitle).toUpperCase();
          save();
        }
      });
      themeEl.appendChild(titleEl);

      // columns container
      const cols = document.createElement('div');
      cols.className = 'theme-columns';

      STATUS.forEach(status => {
        const colEl = document.createElement('div');
        colEl.className = 'column';
        colEl.dataset.themeId = theme.id;
        colEl.dataset.status = status;

        // color class
        if (status === "À faire") colEl.classList.add('column-a-faire');
        else if (status === "En cours") colEl.classList.add('column-en-cours');
        else colEl.classList.add('column-termine');

        // header
        const head = document.createElement('div');
        head.className = 'col-head';
        head.textContent = status.toUpperCase();
        colEl.appendChild(head);

        // tasks list (Sortable target)
        const tasksList = document.createElement('div');
        tasksList.className = 'tasks-list';
        tasksList.dataset.themeId = theme.id;
        tasksList.dataset.status = status;

        // append tasks in order
        const tasks = theme[status] || [];
        tasks.forEach(task => {
          const t = document.createElement('div');
          t.className = 'task';
          t.dataset.taskId = task.id;
          t.innerHTML = `
            <div class="task-header">${escapeHtml(task.title)}</div>
            <div class="task-meta small">
              <div>Équipe: ${escapeHtml(task.team || '-')}</div>
              <div>${task.start ? 'Début: ' + escapeHtml(task.start) : ''}${task.end ? ' | Fin: ' + escapeHtml(task.end) : ''}</div>
              <div>Priorité: ${escapeHtml(task.priority || '')}</div>
            </div>
            <div class="delete-task" title="Supprimer tâche">✖</div>
          `;
          // delete
          t.querySelector('.delete-task').addEventListener('click', (e) => {
            e.stopPropagation();
            if (!confirm('SUPPRIMER CE PROJET ?')) return;
            const idx = findThemeIndex(theme.id);
            if (idx >= 0) {
              const arr = board[idx][status];
              const pos = arr.findIndex(x => x.id === task.id);
              if (pos >= 0) {
                arr.splice(pos,1);
                save();
              }
            }
          });
          // open modal on card click
          t.addEventListener('click', () => openModal(theme.id, status, task.id));
          tasksList.appendChild(t);
        });

        colEl.appendChild(tasksList);

        // add task button
        const addBtn = document.createElement('div');
        addBtn.className = 'add-area';
        addBtn.innerHTML = `<div class="add-sub">+ Ajouter PROJET</div>`;
        addBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = findThemeIndex(theme.id);
          if (idx >= 0) {
            const newTask = { id: uid('task'), title: 'NOUVEAU PROJET', start:'', end:'', team:'', priority:'Moyenne', checklist:[] };
            board[idx][status].push(newTask);
            save();
          }
        });
        colEl.appendChild(addBtn);

        cols.appendChild(colEl);

        // make tasksList sortable
        const sortable = new Sortable(tasksList, {
          group: 'kanban-tasks',
          animation: 150,
          onEnd: (evt) => {
            // moved DOM node is evt.item
            const taskId = evt.item.dataset.taskId;
            if (!taskId) return;
            // derive source and destination
            const fromThemeId = evt.from.dataset.themeId;
            const fromStatus = evt.from.dataset.status;
            const toThemeId = evt.to.dataset.themeId;
            const toStatus = evt.to.dataset.status;

            const fromIdx = findThemeIndex(fromThemeId);
            const toIdx = findThemeIndex(toThemeId);
            if (fromIdx === -1 || toIdx === -1) {
              console.error('theme index not found', fromThemeId, toThemeId);
              render(); // fallback
              return;
            }

            // remove by id from source (not by oldIndex — safer)
            const sourceArr = board[fromIdx][fromStatus];
            const pos = sourceArr.findIndex(t => t.id === taskId);
            if (pos === -1) {
              console.warn('task not found in source', taskId);
              render();
              return;
            }
            const [moved] = sourceArr.splice(pos,1);

            // insert into destination at newIndex
            const destArr = board[toIdx][toStatus];
            const newIndex = evt.newIndex;
            // safety: clamp index
            const insertAt = Math.max(0, Math.min(newIndex, destArr.length));
            destArr.splice(insertAt, 0, moved);

            save();
          }
        });
        sortables.push(sortable);

      }); // end status loop

      // append columns
      themeEl.appendChild(cols);
      boardEl.appendChild(themeEl);
    });
  }

  // modal functions
  function openModal(themeId, status, taskId) {
    currentEdit = { themeId, status, taskId };
    const themeIdx = findThemeIndex(themeId);
    if (themeIdx < 0) return;
    const task = board[themeIdx][status].find(t => t.id === taskId);
    if (!task) return;
    mTitle.value = task.title;
    mStart.value = task.start || '';
    mEnd.value = task.end || '';
    mTeam.value = task.team || '';
    mPriority.value = task.priority || 'Moyenne';
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
  }

  function closeModal() {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
    currentEdit = null;
  }

  modalCancel.addEventListener('click', (e) => { e.stopPropagation(); closeModal(); });

  modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

  modalSave.addEventListener('click', () => {
    if (!currentEdit) return closeModal();
    const { themeId, status, taskId } = currentEdit;
    const themeIdx = findThemeIndex(themeId);
    if (themeIdx < 0) return closeModal();
    const arr = board[themeIdx][status];
    const task = arr.find(t => t.id === taskId);
    if (!task) return closeModal();
    task.title = String(mTitle.value || task.title).toUpperCase();
    task.start = mStart.value || '';
    task.end = mEnd.value || '';
    task.team = mTeam.value || '';
    task.priority = mPriority.value || 'Moyenne';
    save();
    closeModal();
  });

  // export / import
  btnExport.addEventListener('click', () => {
    const dataStr = JSON.stringify(board, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'kanban-export-' + (new Date()).toISOString().slice(0,19) + '.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  importFile.addEventListener('change', (ev) => {
    const f = ev.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(reader.result);
        if (!Array.isArray(parsed)) throw new Error('Fichier invalide : attendu un tableau');
        // basic validation: check structure
        board = parsed.map(t => {
          // ensure id and columns exist
          return {
            id: t.id || uid('theme'),
            title: String(t.title || 'TYPE'),
            "À faire": Array.isArray(t["À faire"]) ? t["À faire"] : [],
            "En cours": Array.isArray(t["En cours"]) ? t["En cours"] : [],
            "Terminé": Array.isArray(t["Terminé"]) ? t["Terminé"] : []
          };
        });
        save();
        alert('Import OK');
      } catch (err) {
        alert('Import failed: ' + err.message);
      }
    };
    reader.readAsText(f);
    importFile.value = '';
  });

  // reset board
  btnReset.addEventListener('click', () => {
    if (!confirm('Réinitialiser le tableau et supprimer les données locales ?')) return;
    board = [];
    localStorage.removeItem(STORAGE_KEY);
    render();
  });

  // add theme
  btnAddTheme.addEventListener('click', () => {
    const title = prompt('NOM DU TYPE DE PROJET :', 'NOUVEAU TYPE');
    const newTheme = {
      id: uid('theme'),
      title: (title ? String(title) : 'NOUVEAU TYPE').toUpperCase(),
      "À faire": [],
      "En cours": [],
      "Terminé": []
    };
    board.push(newTheme);
    save();
  });

  // escapeHtml helper
  function escapeHtml(s) {
    if (s == null) return '';
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // init
  load();
  render();

})(); // IIFE
</script>
</body>
</html>
